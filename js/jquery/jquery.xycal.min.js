/**
 * XYBASE Simple Calendar/Event Layout Component
 *
 * jquery.xycal.js v1.0.3
 *
 * Developer: Imam Kurniawan <geekzy@gmail.com><imam@xybase.com>
 * Copyright (c) 2012 XYBASE <http://www.xybase.com>
 *
 * Methods:
 * - getSelected :
 *   Get curently selected day
 *   return day object of selected day
 *
 * - setSelected(date) :
 *   Set the selected date, all related callbacks will also be invoked
 *   param date the Date object of the selected date
 *   return the selected date as Date Object
 *
 * - today :
 *   Navigate to Today's date
 *
 * Callbacks:
 * - onLoaded : 
 *   Callback when the xycal component is loaded, scope of this is the xycal instance
 * 
 * - onChangeDay(selected, evented)
 *   Callback when the day is changed/selected, scope of this is the xycal instance
 *   param selected the latest selected date as Date Object
 *   param evented boolean value of the selected date has any event(s). true - has event(s); false - no event(s)
 *
 * - onChangeMonth(selected)
 *   Callback when the month is changed, scope of this is the xycal instance
 *   param selected the latest selected date as Date Object
 *
 * - onChangeYear(selected)
 *   Callback when the year is changed, scope of this is the xycal instance
 *   param selected the latest selected date as Date Object
 *
 * Changes:
 * - [10/05/12] Fix event list referencing issue when using configuration, get it straight from selector
 * - [11/05/12] Add options for callback such as when xycal is loaded, date selected, month change & year change
 *              Add public methods to get/set the selected date and navigate to today's date.
 */
(function($){$.fn.xycal=function(options){if(this.length===0){return this}var cal=$.data(this[0],'xycal');if(this.length===1&&cal){return cal}else{return this.each(function(){var el=$(this),xycal=new $.xycal(el,options||{});$.data(this,'xycal',xycal);return xycal})}};$.xycal=function(el,opts){this.el=el;this.settings=$.extend(true,$.xycal.defaults,opts);this.messages=$.xycal.messages;if(!el.is('table')){el.append('<table/>');el=el.find('table');el.css({width:'100%','border-collapse':'collapse'})}if(el.find('thead').length===0){el.append('<thead/>')}if(el.find('tbody').length===0){el.append('<tbody/>')}this._init()};$.extend(true,$.xycal,{defaults:{date:new Date(),weekstart:1,totalDays:[31,28,31,30,31,30,31,31,30,31,30,31],events:[],eventMark:'.',dateFormat:'dd/MM/yyyy',timeFormat:'HH:mm',format:'#{df} #{tf}',ul:'<ul data-role="listview" data-inset="true" data-dividertheme="b"></ul>',li:'<li>#{desc}</li>',div:'<li data-role="list-divider">#{time} - #{title}</li>',callback:{onLoaded:$.noop,onChangeDay:$.noop,onChangeMonth:$.noop,onChangeYear:$.noop}},messages:{days:['Sun','Mon','Tue','Wed','Thu','Fri','Sat'],months:['January','February','March','April','May','June','July','August','September','October','November','December'],noEvents:'No Events',calTitle:'#{m} #{y}'},prototype:{getSelected:function(){var xycal=this;selected=xycal.el.find('table td.ui-xycal-selected');return new Date(xycal.y,xycal.m,selected.length>0?xycal.d:1)},setSelected:function(date){if(!date instanceof Date){throw"Parameter of the selected date must be a Date Object"}var evented,cy=this.y,cm=this.m,y=date.getFullYear(),m=date.getMonth(),d=date.getDate();this.el.find('ul').slideUp(200);this.y=y;this.m=m;this.d=d;this._populateHead(y,m);this._populateDays(y,m,d);this.el.find('.ui-xycal-selected').scrollHere(300);evented=this.el.find('.ui-xycal-evented').length>0;this._initTodayEvents(this.getSelected());this.settings.callback.onChangeDay.call(this,this.getSelected(),evented);if(cm!==this.m){this.settings.callback.onChangeMonth.call(this,this.getSelected())}if(cy!==this.y){this.settings.callback.onChangeYear.call(this,this.getSelected())}return this.getSelected()},today:function(){var year=this.today.getFullYear(),month=this.today.getMonth();this._populateHead(year,month);this._populateDays(year,month);this._initTodayEvents()},_init:function(){this.today=this.settings.date;this.thead=this.el.find('thead');this.tbody=this.el.find('tbody');var year=this.today.getFullYear(),month=this.today.getMonth();this.m=month;this.y=year;this.el.addClass('ui-xycal');this._initDayEvents();this._populateHead(year,month);this._populateDays(year,month);this._initDOMEvents();this._initTodayEvents();this.settings.callback.onLoaded.call(this)},_populateHead:function(y,m){var calTitle,daysHead='',days=[],i,monthNames=this.messages.months,dayNames=this.messages.days,month=monthNames[m!==undefined?m:this.today.getMonth()],year=y!==undefined?y:this.today.getFullYear(),start=this.settings.weekstart,_calTitle=['<tr>','<th class="ui-xycal-shift"><span class="left"></span></th>','<th colspan="5" class="ui-xycal-title">#{title}</th>','<th class="ui-xycal-shift"><span class="right"></span></th>','</tr>'].join(''),_dayHead='<th>#{d}</th>',_daysHead='<tr>#{days}</tr>';calTitle=$.tmpl(_calTitle,{title:$.tmpl(this.messages.calTitle,{m:month,y:year})});for(i=start;i<dayNames.length;i++){days.push(dayNames[i])}for(i=0;i<start;i++){days.push(dayNames[i])}$.each(days,function(i,d){daysHead+=$.tmpl(_dayHead,{d:d})});daysHead=$.tmpl(_daysHead,{days:daysHead});this.thead.empty();this.thead.append(calTitle);this.thead.append(daysHead)},_populateDays:function(y,m,d){var dCount=0,i,ld,today,evented,year=y!==undefined?y:this.today.getFullYear(),month=m!==undefined?m:this.today.getMonth(),lMonth=this._getLastMonth(month),days=this._getDaysOfMonth(month,year),daysRow='',weekRow='',clazz=[],mark=this.settings.eventMark,fDay=this._getFirstDayOfMonth(month,year),lDay=7-(days-fDay)%7,lastDays=this._getDaysOfMonth(lMonth,year),_weekRow='<tr>#{days}</tr>',_dayCell='<td class="#{clazz}">#{d}</td>',_eventMark='<span>#{mark}</span>';for(i=1;i<=fDay;i++){if(fDay>6){break}clazz=[];ld=lastDays-(fDay-i);evented=this._dayEvented(year,lMonth,(ld-1));clazz.push('ui-xycal-others');if(evented){clazz.push('ui-xycal-evented')}daysRow+=$.tmpl(_dayCell,{d:ld,clazz:this._getClazz(clazz)});dCount++}for(i=1;i<=days;i++){clazz=[];today=this._dayToday(year,month,i);evented=this._dayEvented(year,month,i);if(dCount===7){weekRow+=$.tmpl(_weekRow,{days:daysRow});daysRow='';dCount=0}if(today){clazz.push('ui-xycal-today')}if(evented){clazz.push('ui-xycal-evented')}if(d&&d===i){clazz.push('ui-xycal-selected')}daysRow+=$.tmpl(_dayCell,{d:i,clazz:this._getClazz(clazz)});dCount++}for(i=1;i<=lDay;i++){clazz=[];if(dCount<7){evented=this._dayEvented(year,lMonth,i);clazz.push('ui-xycal-others');if(evented){clazz.push('ui-xycal-evented')}daysRow+=$.tmpl(_dayCell,{d:i,clazz:this._getClazz(clazz)});dCount++}else{break}}if(dCount!=7){for(i=1;i<=7-dCount;i++){daysRow+=$.tmpl(_dayCell,{d:(lDay+i),clazz:this._getClazz(clazz)})}}weekRow+=$.tmpl(_weekRow,{days:daysRow});this.tbody.empty();this.tbody.append(weekRow);this.tbody.find('.ui-xycal-evented').append($.tmpl(_eventMark,{mark:mark}))},_initDOMEvents:function(){var navMonth,nextMonth,prevMonth,selectDay,populate,mnav=$('.ui-xycal-shift'),xycal=this,day=$('.ui-xycal tbody td:not(.ui-xycal-others)');populate=function(y,m,d){xycal.m=m;xycal.y=y;xycal.d=d;xycal._populateHead(y,m);xycal._populateDays(y,m,d)};navMonth=function(){var el=$(this),y=xycal.y,rnav=el.is('th')?el.find('.right').length>0:el.is('.ui-xycal-shift .right').length>0,lnav=el.is('th')?el.find('.left').length>0:el.is('.ui-xycal-shift .left').length>0;if(rnav){nextMonth()}else if(lnav){prevMonth()}xycal.settings.callback.onChangeMonth.call(xycal,xycal.getSelected());if(xycal.y!==y){xycal.settings.callback.onChangeYear.call(xycal,xycal.getSelected())}};nextMonth=function(){var m=xycal._getNextMonth(xycal.m),y=m===0?(xycal.y+1):xycal.y;xycal.el.find('ul').slideUp(300);populate(y,m)};prevMonth=function(){var m=xycal._getLastMonth(xycal.m),y=m===11?(xycal.y-1):xycal.y;xycal.el.find('ul').slideUp(300);populate(y,m)};selectDay=function(){var dCell=$(this),events=[],y=xycal.y,m=xycal.m,d=/\d+/.exec(dCell.text()).join(''),today=dCell.is('.ui-xycal-today'),evented=dCell.is('.ui-xycal-evented'),selected=dCell.is('.ui-xycal-selected');if(selected){return}xycal.d=d;$('.ui-xycal-selected').removeClass('ui-xycal-selected');if(!today){dCell.addClass('ui-xycal-selected')}if(evented){events=xycal._getDayEvents(y,m,d);xycal._loadEventListView(events)}else{xycal.el.find('ul').slideUp(200)}xycal.settings.callback.onChangeDay.call(xycal,xycal.getSelected(),evented)};mnav.live('click',navMonth);day.live('click',selectDay)},_initDayEvents:function(){var parse,prepare,xycal=this,settings=xycal.settings,events=settings.events,eventList=xycal.el.find('ul');xycal.events=[];parse=function(ds){var df=settings.dateFormat,tf=settings.timeFormat,dtf=$.tmpl(settings.format,{df:df,tf:tf}),milis=Date.parseDateFormat(ds,dtf);if(milis>0){return new Date(milis)}else{throw"Incorrect event date format - default date format is dd/MM/yyyy and time format is HH:mm"}};prepare=function(){$.each(events,function(i,evt){var d,dt=evt.date||false,tm=evt.time||'00:00';if(!dt){throw"Please specify date in event configuration"}d=parse($.tmpl(settings.format,{df:dt,tf:tm}));xycal.events.push($.extend({_date:d},evt))})};if(eventList&&eventList.length>0){if(!eventList instanceof jQuery){eventList=$(eventList)}eventList.find('li[data]').each(function(){var li=$(this),json=li.attr('data'),data=$.parseJSON(json),strDt=data.date||'',strTm=data.time||'00:00',strDtTm=$.tmpl(settings.format,{df:strDt,tf:strTm}),dt=parse(strDtTm);data=$.extend({_date:dt},data||{});xycal.events.push(data)});prepare();this.el.find('ul').remove()}else{prepare()}},_initTodayEvents:function(date){if(date&&!date instanceof Date){throw"Parameter of the selected date must be a Date Object"}var xycal=this,y=date?date.getFullYear():xycal.today.getFullYear(),m=date?date.getMonth():xycal.today.getMonth(),d=date?date.getDate():xycal.today.getDate(),events=xycal._getDayEvents(y,m,d);if(events.length>0){xycal._loadEventListView(events)}},_loadEventListView:function(evts){var xycal=this,settings=xycal.settings,eul=xycal.el.find('ul'),ul=settings.ul,li=settings.li,div=settings.div;if(eul.length>0){eul.replaceWith(ul)}else{xycal.el.append(ul)}ul=xycal.el.find('ul');ul.hide();$.each(evts,function(i,e){var content;if(div){content=$.tmpl(div,e);ul.append(content)}if(li){content=$.tmpl(li,e);ul.append(content)}});if(ul.listview){ul.listview()}ul.slideDown(200);ul.scrollHere(300)},_getDayEvents:function(y,m,d){var xycal=this,dt=new Date(y,m,d),evts=$.map(this.events,function(evt){var dd=evt._date;if(dd&&dd instanceof Date&&xycal._compareDate(dd,dt)){return evt}});return evts},_getDaysOfMonth:function(m,y){var year=y!==undefined?y:this.today.getFullYear(),month=m!==undefined?m:this.today.getMonth(),totalDays=this.settings.totalDays,days=m===1&&((year%4===0&&year%100!==0)||year%400===0)?29:totalDays[month];return days},_getFirstDayOfMonth:function(m,y){var month=m!==undefined?m:this.today.getMonth(),year=y!==undefined?y:this.today.getFullYear(),start=this.settings.weekstart;return new Date(year,month,1).getDay()-start},_getLastMonth:function(m){var month=m!==undefined?m:this.today.getMonth();return(month-1)<0?11:(month-1)},_getNextMonth:function(m){var month=m!==undefined?m:this.today.getMonth();return(month+1)>11?0:(month+1)},_dayToday:function(y,m,d){var d=new Date(y,m,d);return this._compareDate(d,this.today)},_dayEvented:function(y,m,d){var xycal=this,isEvented=false;$.each(this.events,function(i,evt){var dt=evt._date,dd=new Date(y,m,d);isEvented=xycal._compareDate(dd,dt);return!isEvented});return isEvented},_getClazz:function(clazz){return clazz.length>0?clazz.length>1?clazz.join(' '):clazz[0]:''},_compareDate:function(d1,d2){var d1_y=d1.getFullYear(),d1_m=d1.getMonth(),d1_d=d1.getDate(),d2_y=d2.getFullYear(),d2_m=d2.getMonth(),d2_d=d2.getDate();return d1_y===d2_y&&d1_m===d2_m&&d1_d===d2_d}}})})(jQuery);